@model IEnumerable<IS202.NrlApp.Models.Obstacle>
@{
    ViewData["Title"] = "Dashboard";
    
    var statusFilter = ViewBag.StatusFilter as string ?? "Pending";
    var typeFilter = ViewBag.TypeFilter as string ?? "";
    
    // İstatistikler ViewBag'den (TÜM raporlar)
    var totalCount = ViewBag.TotalCount ?? 0;
    var pendingCount = ViewBag.PendingCount ?? 0;
    var approvedCount = ViewBag.ApprovedCount ?? 0;
    var rejectedCount = ViewBag.RejectedCount ?? 0;
    
    // Filtrelenmiş raporlar (tablo ve harita için)
    var filteredObstacles = Model.ToList();
    var filteredCount = filteredObstacles.Count;
}

<div class="container my-4">
    <div class="mb-4">
        <h2 class="mb-0">
            <i class="bi bi-speedometer2 me-2 text-danger"></i>Dashboard
        </h2>
        <p class="text-muted mb-0">Review and manage obstacle reports</p>
    </div>

    <!-- İstatistik Kartları -->
    <div class="row g-3 mb-4">
        <div class="col-md-3 col-sm-6">
            <div class="card border-primary shadow-sm" style="min-height: 100px;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-primary mb-0 small fw-bold">Total Reports</h6>
                            <h2 class="mb-0 fw-bold text-primary mt-2">@totalCount</h2>
                        </div>
                        <i class="bi bi-flag-fill text-primary fs-2"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="card border-warning shadow-sm" style="min-height: 100px;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-warning mb-0 small fw-bold">Pending Review</h6>
                            <h2 class="mb-0 fw-bold text-warning mt-2">@pendingCount</h2>
                        </div>
                        <i class="bi bi-hourglass-split text-warning fs-2"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="card border-success shadow-sm" style="min-height: 100px;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-success mb-0 small fw-bold">Approved</h6>
                            <h2 class="mb-0 fw-bold text-success mt-2">@approvedCount</h2>
                        </div>
                        <i class="bi bi-check-circle text-success fs-2"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="card border-danger shadow-sm" style="min-height: 100px;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-danger mb-0 small fw-bold">Rejected</h6>
                            <h2 class="mb-0 fw-bold text-danger mt-2">@rejectedCount</h2>
                        </div>
                        <i class="bi bi-x-circle text-danger fs-2"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtreleme -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form method="get" asp-action="Dashboard" class="row g-3">
                <div class="col-md-4">
                    <label for="statusFilter" class="form-label fw-semibold">Status</label>
                    <select name="statusFilter" id="statusFilter" class="form-select">
                        <option value="All" selected="@(statusFilter == "All")">All Statuses</option>
                        <option value="Pending" selected="@(statusFilter == "Pending")">Pending</option>
                        <option value="Approved" selected="@(statusFilter == "Approved")">Approved</option>
                        <option value="Rejected" selected="@(statusFilter == "Rejected")">Rejected</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="typeFilter" class="form-label fw-semibold">Obstacle Type</label>
                    <select name="typeFilter" id="typeFilter" class="form-select">
                        <option value="">All Types</option>
                        <option value="Crane" selected="@(typeFilter == "Crane")">Crane</option>
                        <option value="Mast" selected="@(typeFilter == "Mast")">Mast</option>
                        <option value="Power line" selected="@(typeFilter == "Power line")">Power line</option>
                        <option value="Tower" selected="@(typeFilter == "Tower")">Tower</option>
                        <option value="Building" selected="@(typeFilter == "Building")">Building</option>
                        <option value="Other" selected="@(typeFilter == "Other")">Other</option>
                    </select>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-funnel-fill me-1"></i> Apply Filters
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tablo ve Harita -->
    <div class="row g-4">
        <!-- Tablo (sol taraf) -->
        <div class="col-lg-7">
            <div class="card shadow-sm">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-list-check me-2"></i>Reports
                    </h5>
                    <span class="badge bg-secondary">@filteredCount reports</span>
                </div>
                <div class="card-body p-0">
                    @if (filteredObstacles.Any())
                    {
                        <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                            <table class="table table-hover mb-0">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th style="width: 5%;">ID</th>
                                        <th style="width: 10%;">Type</th>
                                        <th style="width: 15%;">Reporter</th>
                                        <th style="width: 20%;">Comment</th>
                                        <th style="width: 12%;">Location</th>
                                        <th style="width: 10%;">Status</th>
                                        <th style="width: 28%;" class="text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                            @foreach (var item in filteredObstacles)
                            {
                                var statusBadge = item.Status switch
                                {
                                    "Pending" => "bg-warning text-dark",
                                    "Approved" => "bg-success",
                                    "Rejected" => "bg-danger",
                                    _ => "bg-secondary"
                                };

                                <tr class="obstacle-row" data-id="@item.Id" data-lat="@item.Latitude" data-lng="@item.Longitude" style="cursor: pointer;">
                                    <td class="fw-bold">#@item.Id</td>
                                    <td>
                                        <span class="badge bg-secondary">@item.ObstacleType</span>
                                    </td>
                                    <td class="small">
                                        @item.ReporterName<br />
                                        <span class="text-muted">@item.Organization</span>
                                    </td>
                                    <td class="small">
                                        @if (!string.IsNullOrEmpty(item.Comment))
                                        {
                                            @(item.Comment.Length > 50 ? item.Comment.Substring(0, 50) + "..." : item.Comment)
                                        }
                                        else
                                        {
                                            <span class="text-muted">—</span>
                                        }
                                    </td>
                                    <td class="small">
                                        @if (item.Latitude.HasValue && item.Longitude.HasValue)
                                        {
                                            @item.Latitude.Value.ToString("F4")<br />
                                            @item.Longitude.Value.ToString("F4")
                                        }
                                        else
                                        {
                                            <span class="text-muted">—</span>
                                        }
                                    </td>
                                    <td>
                                        <span class="badge @statusBadge">@item.Status</span>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group-vertical btn-group-sm w-100" role="group">
                                            @if (item.Status == "Pending")
                                            {
                                                <!-- Approve/Reject for Pending -->
                                                <div class="btn-group btn-group-sm mb-1" role="group">
                                                    <button type="button" class="btn btn-success" 
                                                            data-bs-toggle="modal" data-bs-target="#approveModal-@item.Id"
                                                            title="Approve">
                                                        <i class="bi bi-check-circle"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-danger" 
                                                            data-bs-toggle="modal" data-bs-target="#rejectModal-@item.Id"
                                                            title="Reject">
                                                        <i class="bi bi-x-circle"></i>
                                                    </button>
                                                </div>
                                            }
                                            
                                            <!-- Edit/Delete for all statuses -->
                                            <div class="btn-group btn-group-sm" role="group">
                                                <a asp-action="Edit" asp-route-id="@item.Id" 
                                                   class="btn btn-outline-primary" title="Edit">
                                                    <i class="bi bi-pencil"></i>
                                                </a>
                                                <button type="button" class="btn btn-outline-danger" 
                                                        onclick="confirmDelete(@item.Id)" title="Delete">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                            
                                            <!-- Hidden delete form -->
                                            <form id="delete-form-@item.Id" asp-action="Delete" asp-route-id="@item.Id" 
                                                  method="post" style="display:none;">
                                                @Html.AntiForgeryToken()
                                            </form>
                                        </div>
                                    </td>
                                </tr>

                                <!-- Approve Modal -->
                                <div class="modal fade" id="approveModal-@item.Id" tabindex="-1">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header bg-success text-white">
                                                <h5 class="modal-title">
                                                    <i class="bi bi-check-circle me-2"></i>Approve Report #@item.Id
                                                </h5>
                                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                            </div>
                                            <form asp-action="Approve" method="post">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="id" value="@item.Id" />
                                                <div class="modal-body">
                                                    <p><strong>Type:</strong> @item.ObstacleType</p>
                                                    <p><strong>Reporter:</strong> @item.ReporterName</p>
                                                    <p><strong>Comment:</strong> @(string.IsNullOrEmpty(item.Comment) ? "No comment" : item.Comment)</p>
                                                    
                                                    <div class="mb-3">
                                                        <label for="feedback-approve-@item.Id" class="form-label">
                                                            Feedback (optional)
                                                        </label>
                                                        <textarea name="feedback" id="feedback-approve-@item.Id" 
                                                                  class="form-control" rows="3" 
                                                                  placeholder="Add any feedback for the reporter..."></textarea>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                    <button type="submit" class="btn btn-success">
                                                        <i class="bi bi-check-circle me-1"></i> Approve Report
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <!-- Reject Modal -->
                                <div class="modal fade" id="rejectModal-@item.Id" tabindex="-1">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header bg-danger text-white">
                                                <h5 class="modal-title">
                                                    <i class="bi bi-x-circle me-2"></i>Reject Report #@item.Id
                                                </h5>
                                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                            </div>
                                            <form asp-action="Reject" method="post">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="id" value="@item.Id" />
                                                <div class="modal-body">
                                                    <p><strong>Type:</strong> @item.ObstacleType</p>
                                                    <p><strong>Reporter:</strong> @item.ReporterName</p>
                                                    <p><strong>Comment:</strong> @(string.IsNullOrEmpty(item.Comment) ? "No comment" : item.Comment)</p>
                                                    
                                                    <div class="mb-3">
                                                        <label for="feedback-reject-@item.Id" class="form-label">
                                                            Reason for rejection (optional)
                                                        </label>
                                                        <textarea name="feedback" id="feedback-reject-@item.Id" 
                                                                  class="form-control" rows="3" 
                                                                  placeholder="Explain why this report is being rejected..."></textarea>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                    <button type="submit" class="btn btn-danger">
                                                        <i class="bi bi-x-circle me-1"></i> Reject Report
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-inbox display-1"></i>
                    <p class="mt-3">No reports found with the current filters.</p>
                </div>
            }
        </div>
    </div>
</div>

<!-- Harita (sağ taraf) -->
<div class="col-lg-5">
    <div class="card shadow-sm sticky-top" style="top: 20px;">
        <div class="card-header bg-light">
            <i class="bi bi-map me-2"></i>Map View
        </div>
        <div class="card-body p-0">
            <div id="dashboardMap" style="height: 600px;"></div>
        </div>
    </div>
</div>
</div>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        (function () {
            // Initialize map
            const map = L.map('dashboardMap').setView([58.146, 7.995], 10);
            
            // Base layer: Satellite
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                maxZoom: 19,
                attribution: '&copy; Esri'
            }).addTo(map);
            
            // Overlay: Labels
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                opacity: 0.4,
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);

            // Disable scroll wheel zoom
            map.scrollWheelZoom.disable();
            map.on('focus', () => map.scrollWheelZoom.enable());
            map.on('blur', () => map.scrollWheelZoom.disable());

            // Add obstacles to map
            const obstacles = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
                Model.Select(o => new {
                    id = o.Id,
                    lat = o.Latitude,
                    lng = o.Longitude,
                    type = o.ObstacleType,
                    reporter = o.ReporterName,
                    status = o.Status,
                    comment = o.Comment
                }).Where(o => o.lat != null && o.lng != null)
            ));

            const markers = {};
            const bounds = [];

            obstacles.forEach(obs => {
                // Marker color based on status
                const color = obs.status === 'Pending' ? 'orange' :
                              obs.status === 'Approved' ? 'green' :
                              obs.status === 'Rejected' ? 'red' : 'gray';

                const icon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background-color: ${color}; width: 25px; height: 25px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 10px;">${obs.id}</div>`,
                    iconSize: [25, 25],
                    iconAnchor: [12, 12]
                });

                const marker = L.marker([obs.lat, obs.lng], { icon: icon }).addTo(map);
                
                marker.bindPopup(`
                    <strong>Report #${obs.id}</strong><br/>
                    <strong>Type:</strong> ${obs.type}<br/>
                    <strong>Reporter:</strong> ${obs.reporter}<br/>
                    <strong>Status:</strong> <span class="badge bg-${color === 'orange' ? 'warning' : color === 'green' ? 'success' : 'danger'}">${obs.status}</span><br/>
                    ${obs.comment ? `<strong>Comment:</strong> ${obs.comment.substring(0, 50)}${obs.comment.length > 50 ? '...' : ''}` : ''}
                `);

                markers[obs.id] = marker;
                bounds.push([obs.lat, obs.lng]);
            });

            // Fit map to show all markers
            if (bounds.length > 0) {
                map.fitBounds(bounds, { padding: [50, 50] });
            }

            // Highlight marker when row is clicked
            document.querySelectorAll('.obstacle-row').forEach(row => {
                row.addEventListener('click', function() {
                    const id = this.dataset.id;
                    const lat = parseFloat(this.dataset.lat);
                    const lng = parseFloat(this.dataset.lng);

                    if (markers[id] && !isNaN(lat) && !isNaN(lng)) {
                        map.setView([lat, lng], 15);
                        markers[id].openPopup();

                        // Highlight row
                        document.querySelectorAll('.obstacle-row').forEach(r => r.classList.remove('table-active'));
                        this.classList.add('table-active');
                    }
                });
            });
        })();

        // Delete confirmation
        function confirmDelete(id) {
            if (confirm('Are you sure you want to delete this report?\n\nThis action cannot be undone.')) {
                document.getElementById('delete-form-' + id).submit();
            }
        }
    </script>
}

