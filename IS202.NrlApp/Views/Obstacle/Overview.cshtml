@model IEnumerable<IS202.NrlApp.Models.Obstacle>
@using System.Text.Json
@{
    ViewData["Title"] = "Map Overview";
}

@* 
    Denne siden viser et fullskjerms kart over alle registrerte hinder.
*@

<div class="container my-4">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
        <h2 class="mb-0"><i class="bi bi-map me-2"></i>Map Overview</h2>

        <div class="d-flex flex-wrap gap-2">
            @* Filter for type *@
            <select id="typeFilter" class="form-select form-select-sm" style="min-width:180px;">
                <option value="">All types</option>
                <option>Crane</option>
                <option>Mast</option>
                <option>Power line</option>
                <option>Tower</option>
                <option>Building</option>
                <option>Other</option>
            </select>

            @* Tekstsøk *@
            <input id="searchInput" class="form-control form-control-sm"
                   placeholder="Search (reporter, org, type, comment)" style="min-width:280px;" />

            @* Ny innmelding *@
            <a asp-controller="Obstacle" asp-action="DataForm" class="btn btn-primary btn-sm">
                <i class="bi bi-flag-fill me-1"></i> New report
            </a>
        </div>
    </div>

    @* Kartkort *@
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div id="overviewMap" style="height: 520px;"></div>
        </div>
        <div class="card-footer d-flex justify-content-between small text-muted">
            <span id="visibleCount"></span>
            <span>Tip: Click a marker/line to see details.</span>
        </div>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        (function () {
            // Serialiserer alle hinder med GeoJSON-data
            const obstacles = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
                Model.Select(m => new {
                    m.ReporterName, 
                    m.Organization, 
                    m.ObstacleType, 
                    m.Comment,
                    Lat = m.Latitude, 
                    Lon = m.Longitude, 
                    Created = m.CreatedAt,
                    GeometryType = m.GeometryType,
                    GeoJson = m.GeoJsonData
                })
            ));

            // Initialiserer kart (sentrert på Kristiansand)
            const map = L.map('overviewMap').setView([58.146, 7.995], 12);
            
            // Grunnlag: Satellittbilde
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                maxZoom: 19,
                maxNativeZoom: 18,
                attribution: '&copy; Esri'
            }).addTo(map);
            
            // Overlag: OpenStreetMap etiketter
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                opacity: 0.4,
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);

            // Bedre UX: unngå utilsiktet zoom ved scroll
            map.scrollWheelZoom.disable();
            map.on('focus', () => map.scrollWheelZoom.enable());
            map.on('blur',  () => map.scrollWheelZoom.disable());

            // Lag for alle objekter
            const allLayers = [];
            const layerGroup = L.layerGroup().addTo(map);

            // Definerer linjefarge (tydelig cyan for satellittbilde)
            const getLineColor = () => '#00ffff'; // Cyan

            // Enkel merkelapp i popup
            function badge(type) {
                return `<span class="badge bg-secondary">${type || 'Obstacle'}</span>`;
            }

            // Popup-innhold (ENGELSK)
            function makePopup(o) {
                const created = o.Created ? new Date(o.Created).toLocaleString() : '';
                const geomType = o.GeometryType ? `<br/><small>Type: ${o.GeometryType}</small>` : '';
                return `
                    <div style="min-width:220px">
                        <div class="mb-1">${badge(o.ObstacleType)}</div>
                        <strong>${o.ReporterName ?? ''}</strong> – ${o.Organization ?? ''}<br/>
                        <em>${o.Comment ?? ''}</em><br/>
                        <small>Lat: ${Number(o.Lat).toFixed(6)}, Lon: ${Number(o.Lon).toFixed(6)}</small>${geomType}<br/>
                        <small class="text-muted">${created}</small>
                    </div>`;
            }

            // Tegner objekter basert på filter/søk
            function rebuildLayers(filterType, q) {
                layerGroup.clearLayers();
                allLayers.length = 0;

                const query = (q || '').toLowerCase();
                const filtered = obstacles.filter(o => {
                    const typeOk = !filterType || (o.ObstacleType || '').toLowerCase() === filterType.toLowerCase();
                    const text = [o.ReporterName, o.Organization, o.ObstacleType, o.Comment]
                        .filter(Boolean).join(' ').toLowerCase();
                    return typeOk && (!query || text.includes(query));
                });

                const bounds = [];

                filtered.forEach(o => {
                    if (o.Lat != null && o.Lon != null) {
                        let layer;

                        // Hvis GeoJSON finnes, bruk den
                        if (o.GeoJson && o.GeoJson.trim() !== '' && o.GeoJson !== 'null') {
                            try {
                                const geojson = JSON.parse(o.GeoJson);
                                
                                layer = L.geoJSON(geojson, {
                                    style: {
                                        color: getLineColor(),
                                        weight: 4,
                                        opacity: 0.9
                                    },
                                    pointToLayer: function (feature, latlng) {
                                        bounds.push([latlng.lat, latlng.lng]);
                                        return L.marker(latlng);
                                    },
                                    onEachFeature: function (feature, lyr) {
                                        // Samler bounds for linjer/polygoner
                                        if (lyr.getBounds) {
                                            const layerBounds = lyr.getBounds();
                                            bounds.push([layerBounds.getNorth(), layerBounds.getEast()]);
                                            bounds.push([layerBounds.getSouth(), layerBounds.getWest()]);
                                        }
                                    }
                                }).addTo(layerGroup);
                                
                                layer.bindPopup(makePopup(o));
                                allLayers.push(layer);
                            } catch (e) {
                                console.error('GeoJSON parse-feil:', e);
                                // Tilbakefall til markør
                                layer = L.marker([o.Lat, o.Lon]).addTo(layerGroup);
                                layer.bindPopup(makePopup(o));
                                bounds.push([o.Lat, o.Lon]);
                                allLayers.push(layer);
                            }
                        } else {
                            // Tilbakefall: Bruk bare lat/lng som markør
                            layer = L.marker([o.Lat, o.Lon]).addTo(layerGroup);
                            layer.bindPopup(makePopup(o));
                            bounds.push([o.Lat, o.Lon]);
                            allLayers.push(layer);
                        }
                    }
                });

                // Tilpasser kartet for å vise alle objekter
                if (bounds.length > 0) {
                    map.fitBounds(bounds, { padding: [50, 50] });
                }

                // Teller (ENGELSK)
                document.getElementById('visibleCount').textContent =
                    `${filtered.length} obstacle(s) visible`;
            }

            // Førstegenerering
            rebuildLayers('', '');

            // UI-hendelser for filtrering
            const typeSel = document.getElementById('typeFilter');
            const searchInput = document.getElementById('searchInput');
            function applyFilters() { rebuildLayers(typeSel.value, searchInput.value); }
            typeSel.addEventListener('change', applyFilters);
            searchInput.addEventListener('input', applyFilters);
        })();
    </script>
}
