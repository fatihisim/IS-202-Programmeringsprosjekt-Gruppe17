@model IEnumerable<IS202.NrlApp.Models.Obstacle>
@using System.Globalization

@{
    ViewData["Title"] = "Obstacle List";
}

<h2 class="mb-4">@ViewData["Title"]</h2>

<a asp-controller="Obstacle" asp-action="DataForm" class="btn btn-primary mb-3">New report</a>

<table class="table table-bordered table-striped table-hover shadow-sm">
    <thead class="table-dark">
        <tr>
            <th>Reporter</th>
            <th>Organization</th>
            <th>Type</th>
            <th>Comment</th>
            <th>Latitude</th>
            <th>Longitude</th>
            <th>Created</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            <tr>
                <td>@item.ReporterName</td>
                <td>@item.Organization</td>
                <td>@item.ObstacleType</td>
                <td>@item.Comment</td>
                <td>@item.Latitude?.ToString("F5", CultureInfo.InvariantCulture)</td>
                <td>@item.Longitude?.ToString("F5", CultureInfo.InvariantCulture)</td>
                <td>@item.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</td>
            </tr>
        }
    </tbody>
</table>

<h3 class="mt-5 mb-3">Map View</h3>
<div id="map" style="height:400px;width:100%;border:1px solid #ddd;border-radius:8px;"></div>

@section Scripts {
    <script>
        // Initialize map
        const map = L.map('map').setView([58.1467, 7.9956], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap'
        }).addTo(map);

        const bounds = [];
        @foreach (var o in Model)
        {
            if (o.Latitude.HasValue && o.Longitude.HasValue)
            {
                var lat = o.Latitude.Value.ToString(CultureInfo.InvariantCulture);
                var lng = o.Longitude.Value.ToString(CultureInfo.InvariantCulture);
                var type = o.ObstacleType ?? "Obstacle";
                var comment = o.Comment ?? "";
                var who = o.ReporterName ?? "";
                var org = o.Organization ?? "";

                @:L.marker([@lat, @lng]).addTo(map)
                @:.bindPopup(`<b>@type</b><br/>@comment<br/><small>@who — @org</small>`);
                @:bounds.push([@lat, @lng]);
            }
        }
        if (bounds.length) {
            map.fitBounds(bounds, { padding: [30, 30] });
        }
    </script>
}
