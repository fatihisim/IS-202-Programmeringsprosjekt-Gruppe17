@model IEnumerable<IS202.NrlApp.Models.Obstacle>
@using System.Text.Json
@using System.Security.Claims
@{
    ViewData["Title"] = "All Reports";
    var currentUserId = User.FindFirstValue(ClaimTypes.NameIdentifier);
    var currentUserRole = User.FindFirst("Role")?.Value;
    var isAdmin = currentUserRole == "Registerfører" || currentUserRole == "Admin";
    
    var statusFilter = ViewBag.StatusFilter as string ?? "";
    var typeFilter = ViewBag.TypeFilter as string ?? "";
    
    // Statistikk fra ViewBag
    var totalCount = ViewBag.TotalCount ?? 0;
    var pendingCount = ViewBag.PendingCount ?? 0;
    var approvedCount = ViewBag.ApprovedCount ?? 0;
    var rejectedCount = ViewBag.RejectedCount ?? 0;
}

<div class="container my-4">
    @* Overskrift *@
    <div class="mb-4">
        <h2 class="mb-0"><i class="bi bi-list-task me-2 text-info"></i>All Reports</h2>
        <p class="text-muted mb-0">View all obstacle reports from all users</p>
    </div>

    @if (totalCount == 0)
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            No obstacle reports found. Be the first to <a asp-action="DataForm" class="alert-link">create a report</a>!
        </div>
    }
    else
    {
        @* Sammendragskort *@
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="card border-primary shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-primary mb-0">Total Reports</h6>
                                <h2 class="mb-0">@totalCount</h2>
                            </div>
                            <i class="bi bi-file-earmark-text display-4 text-primary opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-warning shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-warning mb-0">Pending</h6>
                                <h2 class="mb-0">@pendingCount</h2>
                            </div>
                            <i class="bi bi-hourglass-split display-4 text-warning opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-success shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-success mb-0">Approved</h6>
                                <h2 class="mb-0">@approvedCount</h2>
                            </div>
                            <i class="bi bi-check-circle display-4 text-success opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-danger shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-danger mb-0">Rejected</h6>
                                <h2 class="mb-0">@rejectedCount</h2>
                            </div>
                            <i class="bi bi-x-circle display-4 text-danger opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @* Filtreringsform *@
        <div class="card shadow-sm mb-3">
            <div class="card-body">
                <form method="get" asp-action="List" class="row g-3">
                    <div class="col-md-4">
                        <label for="statusFilter" class="form-label fw-semibold">Status</label>
                        <select name="statusFilter" id="statusFilter" class="form-select">
                            <option value="" selected="@(string.IsNullOrEmpty(statusFilter))">All Statuses</option>
                            <option value="Pending" selected="@(statusFilter == "Pending")">Pending</option>
                            <option value="Approved" selected="@(statusFilter == "Approved")">Approved</option>
                            <option value="Rejected" selected="@(statusFilter == "Rejected")">Rejected</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="typeFilter" class="form-label fw-semibold">Obstacle Type</label>
                        <select name="typeFilter" id="typeFilter" class="form-select">
                            <option value="">All Types</option>
                            <option value="Crane" selected="@(typeFilter == "Crane")">Crane</option>
                            <option value="Mast" selected="@(typeFilter == "Mast")">Mast</option>
                            <option value="Power line" selected="@(typeFilter == "Power line")">Power line</option>
                            <option value="Tower" selected="@(typeFilter == "Tower")">Tower</option>
                            <option value="Building" selected="@(typeFilter == "Building")">Building</option>
                            <option value="Other" selected="@(typeFilter == "Other")">Other</option>
                        </select>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-funnel-fill me-1"></i> Apply Filters
                        </button>
                    </div>
                </form>
            </div>
        </div>

        @* Rapporteringstabell *@
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <span><i class="bi bi-table me-2"></i>Reports Table</span>
                <span class="badge bg-secondary">
                    @if (Model.Count() < totalCount)
                    {
                        @:Showing @Model.Count() of @totalCount reports
                    }
                    else
                    {
                        @:@totalCount reports
                    }
                </span>
            </div>
            <div class="table-responsive">
                <table id="obstacleTable" class="table table-hover align-middle mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th style="width: 50px;">ID</th>
                            <th>Reporter</th>
                            <th>Organization</th>
                            <th>Type</th>
                            <th style="width: 100px;">Status</th>
                            <th>Comment</th>
                            <th class="text-end">Location</th>
                            <th class="text-nowrap">Created</th>
                            @if (isAdmin)
                            {
                                <th style="width: 120px;">Actions</th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                    @if (!Model.Any())
                    {
                        <tr>
                            <td colspan="@(isAdmin ? "9" : "8")" class="text-center py-5">
                                <i class="bi bi-search text-muted display-4 d-block mb-3"></i>
                                <h5 class="text-muted">No reports found with the current filters</h5>
                                <p class="text-muted">Try adjusting your filter criteria or 
                                    <a asp-action="List">clear all filters</a>
                                </p>
                            </td>
                        </tr>
                    }
                    else
                    {
                    @foreach (var o in Model)
                    {
                        var lat = o.Latitude?.ToString("F6");
                        var lon = o.Longitude?.ToString("F6");
                        
                        // Sjekker om brukeren kan redigere/slette denne rapporten
                        var canEdit = isAdmin || (o.UserId == currentUserId);

                        var statusBadgeClass = o.Status switch
                        {
                            "Pending" => "bg-warning text-dark",
                            "Approved" => "bg-success",
                            "Rejected" => "bg-danger",
                            _ => "bg-secondary"
                        };

                        <tr data-id="@o.Id" data-lat="@lat" data-lon="@lon">
                            <td><strong>@o.Id</strong></td>
                            <td>@o.ReporterName</td>
                            <td>@o.Organization</td>
                            <td><span class="badge bg-secondary">@o.ObstacleType</span></td>
                            <td>
                                <span class="badge @statusBadgeClass">@o.Status</span>
                            </td>
                            <td>
                                @if (!string.IsNullOrEmpty(o.Comment))
                                {
                                    @(o.Comment.Length > 50 ? o.Comment.Substring(0, 50) + "..." : o.Comment)
                                }
                                else
                                {
                                    <span class="text-muted">—</span>
                                }
                            </td>
                            <td class="text-end">
                                @if (lat != null && lon != null)
                                {
                                    <small>@lat, @lon</small>
                                }
                                else
                                {
                                    <span class="text-muted">—</span>
                                }
                            </td>
                            <td><small>@o.CreatedAt.ToString("yyyy-MM-dd HH:mm")</small></td>
                            @if (isAdmin)
                            {
                                <td>
                                    <div class="d-flex gap-1">
                                        <a asp-action="Edit" asp-route-id="@o.Id" 
                                           class="btn btn-primary btn-sm text-white" title="Edit">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <button type="button" class="btn btn-danger btn-sm text-white" 
                                                data-bs-toggle="modal" data-bs-target="#deleteModal-@o.Id" title="Delete">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>

                                    @* Skjult sletteskjema *@
                                    <form id="delete-form-@o.Id" asp-action="Delete" asp-route-id="@o.Id" 
                                          method="post" style="display:none;">
                                        @Html.AntiForgeryToken()
                                    </form>

                                    @* Slette-bekreftelsesmodal *@
                                    <div class="modal fade" id="deleteModal-@o.Id" tabindex="-1">
                                        <div class="modal-dialog modal-dialog-centered">
                                            <div class="modal-content">
                                                <div class="modal-header bg-danger text-white">
                                                    <h5 class="modal-title text-white">
                                                        <i class="bi bi-exclamation-triangle-fill me-2"></i>Delete Report
                                                    </h5>
                                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <p class="mb-3">Are you sure you want to delete this <strong>@o.ObstacleType</strong> report?</p>
                                                    <div class="alert alert-warning mb-0">
                                                        <i class="bi bi-info-circle me-2"></i>
                                                        <strong>Warning:</strong> This action cannot be undone.
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                        <i class="bi bi-x-circle me-1"></i>Cancel
                                                    </button>
                                                    <button type="button" class="btn btn-danger" onclick="document.getElementById('delete-form-@o.Id').submit();">
                                                        <i class="bi bi-trash me-1"></i>Delete Report
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            }
                        </tr>
                    }
                    }
                    </tbody>
                </table>
            </div>
        </div>

        @* Kartoversikt *@
        <div class="card shadow-sm">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <span><i class="bi bi-map me-2"></i>Map Overview</span>
                <span class="badge bg-primary">@Model.Count() reports</span>
            </div>
            <div class="card-body p-0">
                <div id="listMap" style="height: 460px;"></div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // Leaflet-kart med radinteraksjoner og GeoJSON-støtte
        (function () {
            // Serialiserer alle hindringer til JSON
            const obstacles = @Html.Raw(JsonSerializer.Serialize(
                Model.Select(m => new {
                    m.Id,
                    m.ReporterName, 
                    m.Organization, 
                    m.ObstacleType, 
                    m.Comment,
                    m.Status,
                    Lat = m.Latitude, 
                    Lon = m.Longitude,
                    GeometryType = m.GeometryType,
                    GeoJson = m.GeoJsonData
                })
            ));

            // Initialiserer kartet (sentrert på Kristiansand)
            const map = L.map('listMap').setView([58.146, 7.995], 12);
            
            // Grunnlag: Satellittbilde
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                maxZoom: 19,
                maxNativeZoom: 18,
                attribution: '&copy; Esri'
            }).addTo(map);
            
            // Overlag: Etiketter
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                opacity: 0.4,
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);

            const layers = {};
            const bounds = [];

            // Definerer markørfarge basert på status
            const getMarkerIcon = (status) => {
                const color = status === 'Approved' ? 'green' : 
                              status === 'Rejected' ? 'red' : 
                              'orange'; // Pending
                
                return L.icon({
                    iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                });
            };

            // Definerer linjefarge basert på status (tydelige farger for satellittbilde)
            const getLineColor = (status) => {
                return status === 'Approved' ? '#00ffff' :  // Cyan
                       status === 'Rejected' ? '#ff0066' :  // Magenta
                       '#ffff00'; // Yellow (Pending)
            };

            // Går gjennom alle hindringer
            obstacles.forEach(o => {
                if (o.Lat != null && o.Lon != null) {
                    const statusBadge = o.Status === 'Approved' ? '✅' : 
                                       o.Status === 'Rejected' ? '❌' : '⏳';
                    
                    const popupContent = `
                        <strong>${o.ObstacleType ?? 'Obstacle'}</strong> ${statusBadge}<br/>
                        <small>ID: ${o.Id} | Status: ${o.Status}</small><br/>
                        ${o.ReporterName ?? ''} – ${o.Organization ?? ''}<br/>
                        <em>${o.Comment ?? ''}</em>
                    `;

                    let layer;

                    // Hvis GeoJSON finnes, bruk den
                    if (o.GeoJson && o.GeoJson.trim() !== '') {
                        try {
                            const geojson = JSON.parse(o.GeoJson);
                            
                            layer = L.geoJSON(geojson, {
                                style: {
                                    color: getLineColor(o.Status),
                                    weight: 4,
                                    opacity: 0.9
                                },
                                pointToLayer: function (feature, latlng) {
                                    bounds.push([latlng.lat, latlng.lng]);
                                    return L.marker(latlng, { icon: getMarkerIcon(o.Status) });
                                },
                                onEachFeature: function (feature, layer) {
                                    // Samler bounds for linjer/polygoner
                                    if (layer.getBounds) {
                                        const layerBounds = layer.getBounds();
                                        bounds.push([layerBounds.getNorth(), layerBounds.getEast()]);
                                        bounds.push([layerBounds.getSouth(), layerBounds.getWest()]);
                                    }
                                }
                            }).addTo(map);
                            
                            layer.bindPopup(popupContent);
                        } catch (e) {
                            console.error('GeoJSON parse-feil for hinder #' + o.Id, e);
                            // Tilbakefall til markør
                            layer = L.marker([o.Lat, o.Lon], { icon: getMarkerIcon(o.Status) }).addTo(map);
                            layer.bindPopup(popupContent);
                            bounds.push([o.Lat, o.Lon]);
                        }
                    } else {
                        // Tilbakefall: Bruk bare lat/lng som markør
                        layer = L.marker([o.Lat, o.Lon], { icon: getMarkerIcon(o.Status) }).addTo(map);
                        layer.bindPopup(popupContent);
                        bounds.push([o.Lat, o.Lon]);
                    }

                    layers[o.Id] = layer;
                }
            });

            // Tilpasser kartet for å vise alle objekter
            if (bounds.length > 0) {
                map.fitBounds(bounds, { padding: [50, 50] });
            }

            // Tabell-rad til kartfokus (klikk)
            let activeLayer = null;

            document.querySelectorAll('#obstacleTable tbody tr').forEach(tr => {
                const id = tr.dataset.id;
                if (!id) return;
                
                tr.addEventListener('click', () => {
                    if (layers[id]) {
                        // Lukker forrige aktiv popup
                        if (activeLayer && activeLayer !== layers[id]) {
                            activeLayer.closePopup();
                        }
                        
                        activeLayer = layers[id];
                        
                        // Hvis det er en GeoJSON-lag (linje/polygon), zoom til bounds
                        if (layers[id].getBounds) {
                            map.fitBounds(layers[id].getBounds(), { padding: [50, 50] });
                        } else {
                            // Hvis det er en markør, zoom til punktet
                            const lat = parseFloat(tr.dataset.lat);
                            const lon = parseFloat(tr.dataset.lon);
                            if (!isNaN(lat) && !isNaN(lon)) {
                                map.setView([lat, lon], Math.max(map.getZoom(), 14), { animate: true });
                            }
                        }
                        layers[id].openPopup();
                    }
                });
            });
        })();
    </script>
}
